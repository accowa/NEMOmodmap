
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Special cases &#8212; NEMOmodmap 1.0 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Combining maps" href="NEMOmodmap_combine.html" />
    <link rel="prev" title="NEMOmodmap" href="NEMOmodmap.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="NEMOmodmap_combine.html" title="Combining maps"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="NEMOmodmap.html" title="NEMOmodmap"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">NEMOmodmap 1.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="special-cases">
<h1>Special cases<a class="headerlink" href="#special-cases" title="Permalink to this headline">¶</a></h1>
<p>The example presented so far was a simple one that required no manual intervention to
complete the processing chain.  Unfortunately there are examples within the NEMO source
tree that fail at the first hurdle by not producing a valid submod.list file. There are
several reasons why this can occur and in each case a quick hand edit is usually
sufficient to resolve the issue. In no particular order of priority, the issues that can
occur are listed here. The reason why they occur and the simplest fix to each is provided
in the subsequent sections:</p>
<ul class="simple">
<li>Multiple CONTAINS statements and duplicate declarations</li>
<li>No MODULE statement</li>
<li>INTERFACE statements occurring before the CONTAINS statement</li>
<li>Apparently empty modules</li>
</ul>
<div class="section" id="multiple-contains-statements">
<h2>Multiple CONTAINS statements<a class="headerlink" href="#multiple-contains-statements" title="Permalink to this headline">¶</a></h2>
<p>This one occurs because of modules that still contain preprocessor keys which can remove large blocks of code. Often
in these circumstances alternative, ‘dummy’ routines are provided to satisfy the linker. Unfortunately this means two
CONTAINS statements and duplicate SUBROUTINE declarations. Take this example (albeit a rather obsolete one) from the
<cite>SBC</cite> directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sbcice_cice.F90
MODULE sbcice_cice
CONTAINS
   INTEGER FUNCTION sbc_ice_cice_alloc
   SUBROUTINE sbc_ice_cice
   SUBROUTINE cice_sbc_init
   SUBROUTINE cice_sbc_in
   SUBROUTINE cice_sbc_out
   SUBROUTINE cice_sbc_hadgam
   SUBROUTINE cice_sbc_final
   SUBROUTINE cice_sbc_force
   SUBROUTINE nemo2cice
   SUBROUTINE cice2nemo
CONTAINS
   SUBROUTINE sbc_ice_cice      ! Dummy routine
   SUBROUTINE cice_sbc_init     ! Dummy routine
   SUBROUTINE cice_sbc_final     ! Dummy routine
</pre></div>
</div>
<p>In this example the solution is obviously just to delete the second CONTAINS statement and
duplicate subroutine names.  Of course this snippet is taken from a lengthy
<cite>newsubmod.list</cite> file so spotting this issue isn’t necessarily straight-forward. To
assist, there is an additional script: <cite>sanity_submod.sh</cite> that does its best to discover
issues and pinpoint line numbers. More on that later though after all the potential issues
have been discussed.</p>
</div>
<div class="section" id="no-module-statement">
<h2>No MODULE statement<a class="headerlink" href="#no-module-statement" title="Permalink to this headline">¶</a></h2>
<p>This one occurs primarily in <cite>.h90</cite> files that aren’t whole files. Here is one example from
the <cite>SBC</cite> directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sbcwave</span><span class="o">.</span><span class="n">F90</span>
<span class="n">MODULE</span> <span class="n">sbcwave</span>
<span class="n">CONTAINS</span>
   <span class="n">SUBROUTINE</span> <span class="n">sbc_stokes</span>
   <span class="n">SUBROUTINE</span> <span class="n">sbc_wstress</span>
   <span class="n">SUBROUTINE</span> <span class="n">sbc_wave</span>
   <span class="n">SUBROUTINE</span> <span class="n">sbc_wave_init</span>

<span class="n">tide</span><span class="o">.</span><span class="n">h90</span>

<span class="n">tideini</span><span class="o">.</span><span class="n">F90</span>
<span class="n">MODULE</span> <span class="n">tideini</span>
<span class="n">CONTAINS</span>
   <span class="n">SUBROUTINE</span> <span class="n">tide_init</span>
</pre></div>
</div>
<p>(note <cite>tide.h90</cite> hidden in the middle there). There are also a few examples in the <cite>NST</cite> directory of non-modular
programs with subroutines but no modules. E.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">agrif2model</span><span class="o">.</span><span class="n">F90</span>
<span class="n">SUBROUTINE</span> <span class="n">Agrif2Model</span>
<span class="n">SUBROUTINE</span> <span class="n">Agrif_Set_numberofcells</span>
<span class="n">SUBROUTINE</span> <span class="n">Agrif_Get_numberofcells</span>
<span class="n">SUBROUTINE</span> <span class="n">Agrif_Allocationcalls</span>
<span class="n">SUBROUTINE</span> <span class="n">Agrif_probdim_modtype_def</span>
<span class="n">SUBROUTINE</span> <span class="n">Agrif_clustering_def</span>
<span class="n">SUBROUTINE</span> <span class="n">Agrif2Model</span>
</pre></div>
</div>
<p>the best solution here is to insert a <cite>MODULE none</cite> statement followed by a CONTAINS
statement before the first SUBROUTINE statement.</p>
</div>
<div class="section" id="interface-statements-occurring-before-the-contains-statement">
<h2>INTERFACE statements occurring before the CONTAINS statement<a class="headerlink" href="#interface-statements-occurring-before-the-contains-statement" title="Permalink to this headline">¶</a></h2>
<p>This one doesn’t indicate any non-conformity to the coding convention but is rather an indication that
generic subroutines are present and human interaction is required to decide how the module contents
are to be presented. Take this example from the <cite>OCE</cite> main directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lib_fortran</span><span class="o">.</span><span class="n">F90</span>
<span class="n">MODULE</span> <span class="n">lib_fortran</span>
   <span class="n">INTERFACE</span> <span class="n">glob_sum</span>
   <span class="n">INTERFACE</span> <span class="n">glob_sum_full</span>
   <span class="n">INTERFACE</span> <span class="n">local_sum</span>
   <span class="n">INTERFACE</span> <span class="n">sum3x3</span>
   <span class="n">INTERFACE</span> <span class="n">glob_min</span>
   <span class="n">INTERFACE</span> <span class="n">glob_max</span>
   <span class="n">INTERFACE</span> <span class="n">SIGN</span>
<span class="n">CONTAINS</span>
   <span class="n">FUNCTION</span> <span class="n">local_sum_2d</span>
   <span class="n">FUNCTION</span> <span class="n">local_sum_3d</span>
   <span class="n">SUBROUTINE</span> <span class="n">sum3x3_2d</span>
   <span class="n">SUBROUTINE</span> <span class="n">sum3x3_3d</span>
   <span class="n">SUBROUTINE</span> <span class="n">DDPDD</span>
   <span class="n">SUBROUTINE</span> <span class="n">glob_sum_1d</span>
   <span class="n">SUBROUTINE</span> <span class="n">glob_sum_2d</span>
   <span class="n">SUBROUTINE</span> <span class="n">glob_sum_full_2d</span>
   <span class="n">SUBROUTINE</span> <span class="n">glob_sum_3d</span>
   <span class="n">SUBROUTINE</span> <span class="n">glob_sum_full_3d</span>
   <span class="n">FUNCTION</span> <span class="n">SIGN_SCALAR</span>
   <span class="n">FUNCTION</span> <span class="n">SIGN_ARRAY_1D</span>
   <span class="n">FUNCTION</span> <span class="n">SIGN_ARRAY_2D</span>
   <span class="n">FUNCTION</span> <span class="n">SIGN_ARRAY_3D</span>
   <span class="n">FUNCTION</span> <span class="n">SIGN_ARRAY_1D_A</span>
   <span class="n">FUNCTION</span> <span class="n">SIGN_ARRAY_2D_A</span>
   <span class="n">FUNCTION</span> <span class="n">SIGN_ARRAY_3D_A</span>
   <span class="n">FUNCTION</span> <span class="n">SIGN_ARRAY_1D_B</span>
   <span class="n">FUNCTION</span> <span class="n">SIGN_ARRAY_2D_B</span>
   <span class="n">FUNCTION</span> <span class="n">SIGN_ARRAY_3D_B</span>
</pre></div>
</div>
<p>showing all the component variations that make up the generic routines and functions is probably not required.
If it is then just delete the INTERFACE statements, but a better solution is probably to delete the internal
variants and just present the generic names. This is achieved by moving the INTERFACE statements below the
CONTAINS statements and deleting any surplus. I.e.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lib_fortran</span><span class="o">.</span><span class="n">F90</span>
<span class="n">MODULE</span> <span class="n">lib_fortran</span>
<span class="n">CONTAINS</span>
   <span class="n">INTERFACE</span> <span class="n">glob_sum</span>
   <span class="n">INTERFACE</span> <span class="n">glob_sum_full</span>
   <span class="n">INTERFACE</span> <span class="n">local_sum</span>
   <span class="n">INTERFACE</span> <span class="n">sum3x3</span>
   <span class="n">INTERFACE</span> <span class="n">glob_min</span>
   <span class="n">INTERFACE</span> <span class="n">glob_max</span>
   <span class="n">INTERFACE</span> <span class="n">SIGN</span>
   <span class="n">FUNCTION</span> <span class="n">local_sum_2d</span>
   <span class="n">FUNCTION</span> <span class="n">local_sum_3d</span>
   <span class="n">SUBROUTINE</span> <span class="n">DDPDD</span>
</pre></div>
</div>
</div>
<div class="section" id="apparently-empty-modules">
<h2>Apparently empty modules<a class="headerlink" href="#apparently-empty-modules" title="Permalink to this headline">¶</a></h2>
<p>Some modules are intentionally empty of any contained routines. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">par_kind</span><span class="o">.</span><span class="n">F90</span>
<span class="n">MODULE</span> <span class="n">par_kind</span>
</pre></div>
</div>
<p>in these cases simply insert a dummy routine [although it would be better to change the logic to handle these
correctly, <code class="docutils literal notranslate"><span class="pre">TBD</span></code>]:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">par_kind</span><span class="o">.</span><span class="n">F90</span>
<span class="n">MODULE</span> <span class="n">par_kind</span>
<span class="n">CONTAINS</span>
   <span class="n">SUBROUTINE</span> <span class="n">empty</span>
</pre></div>
</div>
<p>Some others are apparently empty because they rely on the preprocessor to include content from h90 files. These
are primarily in the OBS directory and can be fixed by suitably combining the list entries for the relevant .F90
and .h90 files.</p>
</div>
<div class="section" id="the-sanity-submod-sh-script">
<h2>The sanity_submod.sh script<a class="headerlink" href="#the-sanity-submod-sh-script" title="Permalink to this headline">¶</a></h2>
<p>As mentioned earlier some of these issues can be difficult to spot in lengthy submod list files. To assist, the
sanity_submod.sh script can be run immediately after generating the newsubmod.list file. It should catch most
issues and pinpoint the first occurrence in the file. A null return indicates no errors were detected. Here are
some examples of its output whilst iteratively fixing issues in <cite>OCE</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mksubmodlist</span>
<span class="n">sanity_submod</span><span class="o">.</span><span class="n">sh</span>
<span class="o">===================================</span>
<span class="o">|</span>      <span class="n">Errors</span> <span class="n">detected</span>            <span class="o">|</span>
<span class="o">===================================</span>
<span class="c1"># files      = 12</span>
<span class="c1"># modules    = 10</span>
<span class="c1"># contains   = 7</span>
<span class="c1"># interfaces = 7</span>
<span class="o">===================================</span>
<span class="n">Some</span> <span class="n">files</span> <span class="n">do</span> <span class="ow">not</span> <span class="n">contain</span> <span class="n">a</span> <span class="n">MODULE</span> <span class="n">statement</span><span class="o">.</span>     <span class="n">First</span> <span class="n">suspect</span> <span class="n">occurs</span> <span class="n">near</span> <span class="n">line</span><span class="p">:</span> <span class="mi">28</span>
<span class="n">See</span> <span class="n">full</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">line</span> <span class="n">numbers</span> <span class="k">for</span> <span class="n">filename</span><span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">MODULE</span> <span class="n">statements</span> <span class="n">below</span><span class="p">:</span>
<span class="n">files</span>  <span class="p">:</span>    <span class="mi">2</span>   <span class="mi">28</span>   <span class="mi">38</span>   <span class="mi">48</span>   <span class="mi">53</span>   <span class="mi">56</span>   <span class="mi">59</span>   <span class="mi">65</span>   <span class="mi">68</span>   <span class="mi">73</span>   <span class="mi">89</span>   <span class="mi">97</span>
<span class="n">Modules</span><span class="p">:</span>    <span class="mi">2</span>   <span class="mi">38</span>   <span class="mi">48</span>   <span class="mi">53</span>   <span class="mi">56</span>   <span class="mi">59</span>   <span class="mi">65</span>   <span class="mi">68</span>   <span class="mi">73</span>   <span class="mi">89</span>
<span class="o">===================================</span>
<span class="n">Some</span> <span class="n">files</span> <span class="n">contain</span> <span class="n">no</span> <span class="ow">or</span> <span class="n">multiple</span> <span class="n">CONTAINS</span> <span class="n">statements</span><span class="o">.</span>  <span class="n">Suspect</span> <span class="ow">not</span> <span class="n">located</span><span class="o">.</span> <span class="n">Probably</span> <span class="n">at</span> <span class="n">the</span> <span class="n">end</span> <span class="n">of</span> <span class="n">submod</span> <span class="nb">list</span>
<span class="n">See</span> <span class="n">full</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">line</span> <span class="n">numbers</span> <span class="k">for</span> <span class="n">MODULE</span> <span class="ow">and</span> <span class="n">CONTAINS</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">statements</span> <span class="n">below</span><span class="p">:</span>
<span class="n">Modules</span> <span class="p">:</span>    <span class="mi">2</span>   <span class="mi">38</span>   <span class="mi">48</span>   <span class="mi">53</span>   <span class="mi">56</span>   <span class="mi">59</span>   <span class="mi">65</span>   <span class="mi">68</span>   <span class="mi">73</span>   <span class="mi">89</span>
<span class="n">Contains</span><span class="p">:</span>    <span class="mi">9</span>   <span class="mi">38</span>   <span class="mi">48</span>   <span class="mi">59</span>   <span class="mi">68</span>   <span class="mi">73</span>   <span class="mi">89</span>
<span class="o">===================================</span>

<span class="n">vi</span> <span class="n">newsubmod</span><span class="o">.</span><span class="n">list</span>   <span class="c1">#remove files without MODULES</span>
<span class="n">sanity_submod</span><span class="o">.</span><span class="n">sh</span>
<span class="o">===================================</span>
<span class="o">|</span>      <span class="n">Errors</span> <span class="n">detected</span>            <span class="o">|</span>
<span class="o">===================================</span>
<span class="c1"># files      = 10</span>
<span class="c1"># modules    = 10</span>
<span class="c1"># contains   = 7</span>
<span class="c1"># interfaces = 7</span>
<span class="o">===================================</span>
<span class="n">Some</span> <span class="n">files</span> <span class="n">contain</span> <span class="n">no</span> <span class="ow">or</span> <span class="n">multiple</span> <span class="n">CONTAINS</span> <span class="n">statements</span><span class="o">.</span>  <span class="n">Suspect</span> <span class="ow">not</span> <span class="n">located</span><span class="o">.</span> <span class="n">Probably</span> <span class="n">at</span> <span class="n">the</span> <span class="n">end</span> <span class="n">of</span> <span class="n">submod</span> <span class="nb">list</span>
<span class="n">See</span> <span class="n">full</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">line</span> <span class="n">numbers</span> <span class="k">for</span> <span class="n">MODULE</span> <span class="ow">and</span> <span class="n">CONTAINS</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">statements</span> <span class="n">below</span><span class="p">:</span>
<span class="n">Modules</span> <span class="p">:</span>    <span class="mi">2</span>   <span class="mi">28</span>   <span class="mi">38</span>   <span class="mi">43</span>   <span class="mi">46</span>   <span class="mi">49</span>   <span class="mi">55</span>   <span class="mi">58</span>   <span class="mi">63</span>   <span class="mi">79</span>
<span class="n">Contains</span><span class="p">:</span>    <span class="mi">9</span>   <span class="mi">28</span>   <span class="mi">38</span>   <span class="mi">49</span>   <span class="mi">58</span>   <span class="mi">63</span>   <span class="mi">79</span>
<span class="o">===================================</span>

<span class="n">vi</span> <span class="n">newsubmod</span><span class="o">.</span><span class="n">list</span>   <span class="c1"># Add CONTAINS and SUBROUTINE empty lines where necessary</span>
<span class="n">sanity_submod</span><span class="o">.</span><span class="n">sh</span>
<span class="n">Error</span> <span class="n">detected</span><span class="p">:</span> <span class="n">misplaced</span> <span class="n">INTERFACE</span> <span class="n">statement</span> <span class="n">at</span> <span class="n">line</span><span class="p">:</span> <span class="mi">3</span>

<span class="n">vi</span> <span class="n">newsubmod</span><span class="o">.</span><span class="n">list</span>   <span class="c1"># Sort out misplaced interface statements</span>
<span class="n">sanity_submod</span><span class="o">.</span><span class="n">sh</span>

<span class="c1"># No return. Job done</span>

<span class="n">mv</span> <span class="n">newsubmod</span><span class="o">.</span><span class="n">list</span> <span class="n">OCE_submod</span><span class="o">.</span><span class="n">list</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/NEMO-Website.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Special cases</a><ul>
<li><a class="reference internal" href="#multiple-contains-statements">Multiple CONTAINS statements</a></li>
<li><a class="reference internal" href="#no-module-statement">No MODULE statement</a></li>
<li><a class="reference internal" href="#interface-statements-occurring-before-the-contains-statement">INTERFACE statements occurring before the CONTAINS statement</a></li>
<li><a class="reference internal" href="#apparently-empty-modules">Apparently empty modules</a></li>
<li><a class="reference internal" href="#the-sanity-submod-sh-script">The sanity_submod.sh script</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="NEMOmodmap.html"
                        title="previous chapter">NEMOmodmap</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="NEMOmodmap_combine.html"
                        title="next chapter">Combining maps</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/NEMOmodmap_exceptions.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="NEMOmodmap_combine.html" title="Combining maps"
             >next</a> |</li>
        <li class="right" >
          <a href="NEMOmodmap.html" title="NEMOmodmap"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">NEMOmodmap 1.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Andrew C. Coward, National Oceanography Centre, UK.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>